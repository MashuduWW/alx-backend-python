#!/bin/bash



set -e

echo "🚀 Applying Blue Deployment..."
kubectl apply -f blue_deployment.yaml

echo "🚀 Applying Green Deployment..."
kubectl apply -f green_deployment.yaml

echo "📦 Ensuring both deployments are running..."
kubectl get deployments -l app=messaging-app

echo "🔍 Checking pods..."
kubectl get pods -l app=messaging-app

# Check logs of green pods for errors
GREEN_PODS=$(kubectl get pods -l app=messaging-app,version=green -o jsonpath='{.items[*].metadata.name}')

echo "📝 Checking logs of green pods..."
for pod in $GREEN_PODS
do
    echo "➡️ Logs for $pod:"
    kubectl logs $pod || echo "⚠️ Failed to get logs for $pod"
done

echo "✅ Blue-Green deployments applied successfully."
echo "👉 To switch traffic to green, update kubeservice.yaml selector to 'version: green' and run:"
echo "   kubectl apply -f kubeservice.yaml"
